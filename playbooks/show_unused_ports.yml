---
- name: Show unused ports from all devices
  hosts: all_devices
  gather_facts: no
  vars:
    reports_dir: "{{ playbook_dir }}/../reports"
  
  tasks:
    - name: Create reports directory if it doesn't exist
      ansible.builtin.file:
        path: "{{ reports_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
    
    - name: Get all interfaces information
      arista.eos.eos_command:
        commands:
          - show interfaces status
      register: interfaces_result
    
    - name: Filter unused ports (admin down or not connected)
      ansible.builtin.set_fact:
        unused_ports: "{{ interfaces_result.stdout_lines[0] | select('match', '(?i).*(admin down|notconnect|disabled).*') | list }}"
    
    - name: Get current timestamp
      ansible.builtin.shell: date
      register: timestamp_result
      delegate_to: localhost
      run_once: true
      changed_when: false
    
    - name: Save unused ports report to file
      ansible.builtin.copy:
        content: |
          Device: {{ inventory_hostname }}
          Timestamp: {{ timestamp_result.stdout | default('N/A') }}
          
          Unused Ports (admin down, not connected, or disabled):
          {% if unused_ports | length > 0 %}
          {% for line in unused_ports %}
          {{ line }}
          {% endfor %}
          {% else %}
          No unused ports found on this device.
          {% endif %}
          
          Note: This demo considers ports as "unused" if they are:
          - Administratively down
          - Not connected
          - Disabled
        dest: "{{ reports_dir }}/{{ inventory_hostname }}_unused_ports.txt"
        mode: '0644'
      delegate_to: localhost
    
    - name: Display summary
      ansible.builtin.debug:
        msg: "Unused ports report saved to {{ reports_dir }}/{{ inventory_hostname }}_unused_ports.txt ({{ unused_ports | length }} unused ports found)"

