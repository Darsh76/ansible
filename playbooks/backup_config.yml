---
- name: Backup running configuration from leaf switches
  hosts: leafs
  gather_facts: no
  vars:
    backup_dir: "{{ playbook_dir }}/../backups"
  
  tasks:
    - name: Get current timestamp
      ansible.builtin.shell: date +%s
      register: timestamp_result
      delegate_to: localhost
      run_once: true
      changed_when: false
    
    - name: Set timestamp variable
      ansible.builtin.set_fact:
        timestamp: "{{ timestamp_result.stdout }}"
      delegate_to: localhost
      run_once: true
    
    - name: Create backups directory if it doesn't exist
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      run_once: true
    
    - name: Get running configuration from device
      arista.eos.eos_command:
        commands:
          - show running-config
      register: running_config
    
    - name: Save running configuration to backup file
      ansible.builtin.copy:
        content: "{{ running_config.stdout[0] }}"
        dest: "{{ backup_dir }}/{{ inventory_hostname }}_config_backup_{{ timestamp }}.txt"
        mode: '0644'
      delegate_to: localhost
    
    - name: Display backup location
      ansible.builtin.debug:
        msg: "Backup saved to: {{ backup_dir }}/{{ inventory_hostname }}_config_backup_{{ timestamp }}.txt"

