---
- name: Generate interface status report from all devices
  hosts: all_devices
  gather_facts: no
  vars:
    reports_dir: "{{ playbook_dir }}/../reports"
    raw_dir: "{{ reports_dir }}/interfaces_raw"
    summary_dir: "{{ reports_dir }}/interfaces_summary"
  
  tasks:
    - name: Create report directories if they don't exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ raw_dir }}"
        - "{{ summary_dir }}"
      delegate_to: localhost
      run_once: true
    
    - name: Get interface status from device
      arista.eos.eos_command:
        commands:
          - show interfaces status
      register: interface_status
    
    - name: Get current timestamp
      ansible.builtin.shell: date
      register: timestamp_result
      delegate_to: localhost
      run_once: true
      changed_when: false
    
    - name: Save raw interface output per device
      ansible.builtin.copy:
        content: |
          Device: {{ inventory_hostname }}
          Timestamp: {{ timestamp_result.stdout | default('N/A') }}
          
          {{ interface_status.stdout[0] }}
        dest: "{{ raw_dir }}/{{ inventory_hostname }}_interfaces_raw.txt"
        mode: '0644'
      delegate_to: localhost
    
    - name: Count interfaces by state
      ansible.builtin.set_fact:
        interface_counts:
          up: "{{ interface_status.stdout_lines[0] | select('match', '(?i).*(connected|up).*') | list | length }}"
          down: "{{ interface_status.stdout_lines[0] | select('match', '(?i).*(down|notconnect|disabled).*') | list | length }}"
          total: "{{ interface_status.stdout_lines[0] | select('match', '(?i).*^Et|^Ma|^Lo.*') | list | length }}"
    
    - name: Save per-device summary
      ansible.builtin.copy:
        content: |
          Device: {{ inventory_hostname }}
          Timestamp: {{ timestamp_result.stdout | default('N/A') }}
          
          Interface Summary:
          - Total Interfaces: {{ interface_counts.total }}
          - Interfaces UP: {{ interface_counts.up }}
          - Interfaces DOWN: {{ interface_counts.down }}
        dest: "{{ summary_dir }}/{{ inventory_hostname }}_summary.txt"
        mode: '0644'
      delegate_to: localhost
    
    - name: Display summary
      ansible.builtin.debug:
        msg: "Interface report saved for {{ inventory_hostname }} - Total: {{ interface_counts.total }}, UP: {{ interface_counts.up }}, DOWN: {{ interface_counts.down }}"

